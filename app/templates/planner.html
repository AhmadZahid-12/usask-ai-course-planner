{% extends "base.html" %}
{% block content %}

<h1>Degree Planner (Phase 3)</h1>

<p>
  Load a degree template, mark completed courses, and the planner will show:
  <b>Unlocked</b> and <b>Locked</b> courses (with missing prerequisites).
</p>

<div style="margin: 10px 0; display:flex; gap:8px; flex-wrap:wrap;">
  <button id="loadDegreeBtn">Load BSc CS Template</button>
  <button id="loadPlanBtn">Load Latest Saved Plan</button>
  <button id="savePlanBtn">Save Plan</button>
  <button id="exportBtn">Export JSON</button>
  <button id="importBtn">Import JSON</button>
</div>

<div style="margin: 8px 0;">
  <label>Plan name: <input id="planName" value="My Plan" /></label>
</div>

<div style="margin: 8px 0;">
  <div>Notes:</div>
  <textarea id="planNotes" rows="4" style="width: min(900px, 95%);"></textarea>
</div>

<hr />

<div style="display:flex; gap:40px; align-items:flex-start; margin-top: 16px;">
  <div style="flex:1; min-width: 260px;">
    <h2>Required Courses</h2>
    <div id="requiredList"></div>
  </div>

  <div style="flex:1; min-width: 260px;">
    <h2>Unlocked Next Courses</h2>
    <div id="unlockedList"></div>

    <h2 style="margin-top: 18px;">Locked Courses (why)</h2>
    <div id="lockedList"></div>
  </div>
</div>

<div id="statusLine" style="margin-top: 16px; color:#444;"></div>

<script>
let DEGREE_REQUIRED = [];

async function fetchJSON(url, opts={}) {
  const r = await fetch(url, opts);
  if (!r.ok) {
    const txt = await r.text();
    throw new Error(`${r.status} ${r.statusText}: ${txt}`);
  }
  return await r.json();
}

function checkboxRow(code) {
  const id = `c_${code.replaceAll(" ", "_")}`;
  return `
    <div style="margin:6px 0;">
      <label>
        <input type="checkbox" id="${id}" data-code="${code}">
        ${code}
      </label>
    </div>
  `;
}

function getCompleted() {
  const boxes = document.querySelectorAll("input[type=checkbox][data-code]");
  const completed = [];
  boxes.forEach(b => {
    if (b.checked) completed.push(b.dataset.code);
  });
  return completed;
}

function setCompleted(completedList) {
  const set = new Set((completedList || []).map(x => String(x)));
  document.querySelectorAll("input[type=checkbox][data-code]").forEach(b => {
    b.checked = set.has(b.dataset.code);
  });
}

async function refreshStatus() {
  const completed = getCompleted();

  const status = await fetchJSON("/api/planner/status", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ completed })
  });

  // unlocked
  const unlockedDiv = document.getElementById("unlockedList");
  if (!status.unlocked || status.unlocked.length === 0) {
    unlockedDiv.innerHTML = "<p>None unlocked yet.</p>";
  } else {
    unlockedDiv.innerHTML = "<ul>" + status.unlocked.map(c => `<li>${c}</li>`).join("") + "</ul>";
  }

  // locked w reasons
  const lockedDiv = document.getElementById("lockedList");
  if (!status.locked || status.locked.length === 0) {
    lockedDiv.innerHTML = "<p>Nothing locked (or you completed everything).</p>";
  } else {
    lockedDiv.innerHTML = status.locked.map(item => {
      const miss = (item.missing_prereqs || []);
      const why = miss.length ? `Missing: <b>${miss.join(", ")}</b>` : "Missing prerequisites";
      return `<div style="margin:8px 0; padding:8px; border:1px solid #ddd;">
        <div><b>${item.code}</b></div>
        <div style="color:#444; margin-top:4px;">${why}</div>
      </div>`;
    }).join("");
  }

  document.getElementById("statusLine").textContent =
    `Required: ${status.required_count} | Completed: ${status.completed_count} | Unlocked: ${(status.unlocked||[]).length} | Locked: ${(status.locked||[]).length}`;
}

async function loadDegreeTemplate() {
  const degree = await fetchJSON("/api/degree/bsci_cs");
  DEGREE_REQUIRED = degree.required_courses || [];

  // render checkboxes
  const list = document.getElementById("requiredList");
  list.innerHTML = DEGREE_REQUIRED.map(checkboxRow).join("");

  // attach listeners
  document.querySelectorAll("input[type=checkbox][data-code]").forEach(b => {
    b.addEventListener("change", refreshStatus);
  });

  // bulk scrape/cache these courses so prereqs exist in DB
  await fetchJSON("/api/courses/bulk_scrape", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ codes: DEGREE_REQUIRED })
  });

  // now compute status
  await refreshStatus();
}

async function savePlan() {
  const name = document.getElementById("planName").value || "My Plan";
  const notes = document.getElementById("planNotes").value || "";
  const completed = getCompleted();

  await fetchJSON("/api/plan/save", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ name, notes, completed })
  });

  alert("Saved!");
}

async function loadLatestPlan() {
  const data = await fetchJSON("/api/plan/load");
  if (!data.plan) {
    alert("No saved plan found yet.");
    return;
  }

  const plan = data.plan;
  document.getElementById("planName").value = plan.name || "My Plan";
  document.getElementById("planNotes").value = plan.notes || "";

  let completed = [];
  try { completed = JSON.parse(plan.completed_json || "[]"); } catch(e) {}

  setCompleted(completed);
  await refreshStatus();
}

async function exportPlan() {
  const data = await fetchJSON("/api/plan/export");
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "plan.json";
  a.click();
  URL.revokeObjectURL(url);
}

async function importPlan() {
  const txt = prompt("Paste exported JSON here:");
  if (!txt) return;
  let obj;
  try { obj = JSON.parse(txt); }
  catch(e) { alert("Invalid JSON"); return; }

  await fetchJSON("/api/plan/import", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });

  alert("Imported + saved as a new plan. Now loading latest...");
  await loadLatestPlan();
}

document.getElementById("loadDegreeBtn").addEventListener("click", loadDegreeTemplate);
document.getElementById("savePlanBtn").addEventListener("click", savePlan);
document.getElementById("loadPlanBtn").addEventListener("click", loadLatestPlan);
document.getElementById("exportBtn").addEventListener("click", exportPlan);
document.getElementById("importBtn").addEventListener("click", importPlan);

// optional: auto-load degree on page open
// loadDegreeTemplate();
</script>

{% endblock %}